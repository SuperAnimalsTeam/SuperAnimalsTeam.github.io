<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SACHAT(PRE1)</title>
    <meta http-equiv="refresh" content="20">
</head>
<body bgcolor="#90EE90" onload="pageload()">
    <img src="8.ico" alt="SACHAT(PRE1)">
    <br><textarea id="ta" rows="20" cols="50" style="background-color:#90EE90; font-size:23px" readonly></textarea>
    <button id="pgup" onclick="pgup()" hidden="hidden">上一页</button>
    <p id="p1"></p>
    <p id="p2"></p>
    <p id="p3"></p>
    <p id="p4"></p>
    <p id="p5"></p>
    <p id="p6"></p>
    <p id="p7"></p>
    <p id="p8"></p>
    <p id="p9"></p>
    <p id="p0"></p>
    <button id="pgdn" onclick="pgdn()" hidden="hidden">下一页</button>
    昵称： <input id="usrn" /><br>消息内容： <input id="msg" /><br><button id="send" onclick="send()" >发送</button>
</body>
<script>
    var m= new Array({id:-1,msg:"",usr:""});
    function pageload() {
        const reques = indexedDB.open("sutest", 1);
        reques.onupgradeneeded = function(event) {
            db = event.target.result;
            if(!db.objectStoreNames.contains("msg")){var objectStorem = db.createObjectStore("msg", { keyPath: 'id' });}
        };
        reques.onsuccess = function(event) {
            db = event.target.result;
            var t=db.transaction(["msg"], "readwrite");
            var objectStore = t.objectStore("msg");
            var q=objectStore.count();
            var cnt=0;
            q.onsuccess = function(event) {
                cnt=event.target.result;
                console.log(cnt);
                var c=0;
                var s=0;
                for(var i=1;i<=cnt;i++){
                    if(s==i){
                        continue;
                    }
                    else{
                        s++;
                    }
                    var t=db.transaction(["msg"], "readwrite");
                    var objectStore = t.objectStore("msg");
                    var w=objectStore.get(i);
                    w.onerror = function(event) {
                        //alert("error");
                    }
                    w.onsuccess = function(event) {
                        m[event.target.result.id]=event.target.result;
                        var t=document.getElementById("ta");
                        t.value+=m[event.target.result.id]["usr"];
                        t.value+=": ";
                        t.value+=m[event.target.result.id]["msg"];
                        t.value+="\n";
                        t.innerHTML+="<br>";
                        c++;
                        console.log(c);
                        if(c==cnt){
                            console.log("a");
                            console.log(m);
                            /*if(cnt>=10){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                                document.getElementById("p6").innerHTML=m[cnt-5]["usr"]+": "+m[cnt-5]["msg"];
                                document.getElementById("p7").innerHTML=m[cnt-6]["usr"]+": "+m[cnt-6]["msg"];
                                document.getElementById("p8").innerHTML=m[cnt-7]["usr"]+": "+m[cnt-7]["msg"];
                                document.getElementById("p9").innerHTML=m[cnt-8]["usr"]+": "+m[cnt-8]["msg"];
                                document.getElementById("p0").innerHTML=m[cnt-9]["usr"]+": "+m[cnt-9]["msg"];
                            }
                            else if(cnt==9){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                                document.getElementById("p6").innerHTML=m[cnt-5]["usr"]+": "+m[cnt-5]["msg"];
                                document.getElementById("p7").innerHTML=m[cnt-6]["usr"]+": "+m[cnt-6]["msg"];
                                document.getElementById("p8").innerHTML=m[cnt-7]["usr"]+": "+m[cnt-7]["msg"];
                                document.getElementById("p9").innerHTML=m[cnt-8]["usr"]+": "+m[cnt-8]["msg"];
                            }
                            else if(cnt==8){
                                console.log(m);
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                                document.getElementById("p6").innerHTML=m[cnt-5]["usr"]+": "+m[cnt-5]["msg"];
                                document.getElementById("p7").innerHTML=m[cnt-6]["usr"]+": "+m[cnt-6]["msg"];
                                document.getElementById("p8").innerHTML=m[cnt-7]["usr"]+": "+m[cnt-7]["msg"];
                            }
                            else if(cnt==7){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                                document.getElementById("p6").innerHTML=m[cnt-5]["usr"]+": "+m[cnt-5]["msg"];
                                document.getElementById("p7").innerHTML=m[cnt-6]["usr"]+": "+m[cnt-6]["msg"];
                            }
                            else if(cnt==6){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                                document.getElementById("p6").innerHTML=m[cnt-5]["usr"]+": "+m[cnt-5]["msg"];
                            }
                            else if(cnt==5){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                                document.getElementById("p5").innerHTML=m[cnt-4]["usr"]+": "+m[cnt-4]["msg"];
                            }
                            else if(cnt==4){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                                document.getElementById("p4").innerHTML=m[cnt-3]["usr"]+": "+m[cnt-3]["msg"];
                            }
                            else if(cnt==3){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                                document.getElementById("p3").innerHTML=m[cnt-2]["usr"]+": "+m[cnt-2]["msg"];
                            }
                            else if(cnt==2){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                                document.getElementById("p2").innerHTML=m[cnt-1]["usr"]+": "+m[cnt-1]["msg"];
                            }
                            else if(cnt==1){
                                document.getElementById("p1").innerHTML=m[cnt]["usr"]+": "+m[cnt]["msg"];
                            }*/

                        }
                    }
                    if(i==cnt){
                        db.close();
                    }
                }
            }
        }
        reques.onerror = function(event) {
            console.error('Database error:', event.target.error);
        };
    }
    function send(){
        const reques = indexedDB.open("sutest", 1);
        reques.onsuccess = function(event) {
            db = event.target.result;
            var t = db.transaction(["msg"], "readwrite");
            var objectStore = t.objectStore("msg");
            var q = objectStore.count();
            var cnt = 0;
            q.onsuccess = function (event) {
                cnt = event.target.result;
                objectStore.add({
                    id: cnt + 1,
                    msg: document.getElementById("msg").value,
                    usr: document.getElementById("usrn").value
                });
                document.getElementById("p2").innerHTML = document.getElementById("p3").innerHTML;
                document.getElementById("p3").innerHTML = document.getElementById("p4").innerHTML;
                document.getElementById("p4").innerHTML = document.getElementById("p5").innerHTML;
                document.getElementById("p5").innerHTML = document.getElementById("p6").innerHTML;
                document.getElementById("p6").innerHTML = document.getElementById("p7").innerHTML;
                document.getElementById("p7").innerHTML = document.getElementById("p8").innerHTML;
                document.getElementById("p8").innerHTML = document.getElementById("p9").innerHTML;
                document.getElementById("p9").innerHTML = document.getElementById("p0").innerHTML;
                document.getElementById("p1").innerHTML = document.getElementById("p2").innerHTML;
                document.getElementById("ta").value += document.getElementById("usrn").value+": "+document.getElementById("msg").value+"\n";
            }
            db.close();
        }
    }
    function pgup() {

    }
    function pgdn() {

    }
</script>
</html>